<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dianba.pos.menu.mapper.OrderMapper">
    <!-- 查询使用商米pos每个月的盈利金额-->
  <select id="queryOrderList" resultType="java.util.HashMap">
SELECT
  sum(om.price-os.stock_price) sum_money,
  ca.create_time create_time
FROM  `order` o
  INNER JOIN merchant m  ON o.merchant_id=m.id
  JOIN user us ON us.id=m.user_id
  JOIN `0085_cashier` ca on ca.merchant_id=m.id
  INNER JOIN order_menu om on om.order_id =o.id
  INNER JOIN  menu me on me.id=om.menu_id
  INNER JOIN `0085_stock` AS os ON os.menu_id=me.id
 WHERE m.id=#{id} AND  ca.create_time BETWEEN   #{create_time} AND #{now_time}
  </select>
  <!--获取商家使用pos机的时间-->
  <select id="getPosStrtTimeByMerchant" resultType="java.lang.Long">

    SELECT cas.create_time
    FROM 0085_cashier cas
    JOIN merchant me on cas.merchant_id=me.id
    WHERE me.id=#{id}

  </select>
  <!--查詢商家每天的盈利數據-->
  <select id="selectPosProfitByDay" resultType="com.dianba.pos.order.vo.PosProfitByDayEntity">

    SELECT o.id,
    sum( om.price) sale_price，
    sum(os.stock_price) stock_price,
    om.price-os.stock_price order_profit,
    us.id user_id user_id,
    us.mobile user_mobile,
    ca.name user_name,
    FROM_UNIXTIME( o.complete_time,'%Y-%m-%d') ,
    ca.id_card id_card,
    us.first_order_time firest_time,
    ca.create_time
    FROM  `order` o
    INNER JOIN merchant m  ON o.merchant_id=m.id
    JOIN user us ON us.id=m.user_id
    JOIN `0085_cashier` ca on ca.merchant_id=m.id
    INNER JOIN order_menu om on om.order_id =o.id
    INNER JOIN  menu me on me.id=om.menu_id
    INNER JOIN `0085_stock` AS os ON os.menu_id=me.id
    WHERE m.id=#merchant_id# AND o.state ='confirm'  GROUP BY  FROM_UNIXTIME( o.complete_time,'%Y-%m-%d')

  </select>
  <!--查询是否是pos机商家用户-->
  <select id="verifyMerchantUser" resultType="java.util.HashMap">
    SELECT count(1) num
    ,ca.merchant_id merchant_id
    ,us.id user_id
    FROM `0085_cashier` ca
    JOIN merchant me on ca.merchant_id=me.id
    JOIN user us on us.id=me.user_id
    where ca.name=#{user_name}  AND ca.id_card=#{card} AND ca.mobile=#{phone}
  </select>
  <!--获取商家注册时间-->
  <select id="getMerchantCreate" resultType="java.lang.Long">

    SELECT me.create_time
    FROM merchant me
    WHERE id=#{id};

  </select>
</mapper>