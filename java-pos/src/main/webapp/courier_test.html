
<extend name="_Common:base_index" />
<block name="ext_css">

</block>
<block name="ext_js">
<script type="text/javascript" src="http://www.w3school.com.cn/jquery/jquery-1.11.1.min.js"></script>
<script type="text/javascript">
	$(document).ready(function(){
		$('#courierTable').on('click','#plus',function(){
    	
        var trStr = '';
        trStr = '<tr>'+
                    '<td><input type="number" class="courierID"/></td>'+
                    '<td><input type="number" class="courierName"/></td>'+
                    '<td><input type="number" class="lon"/></td>'+
                    '<td><input type="number" class="dim"/></td>'+
                    '<td><button class="btn btn-success upload">上传</button><button class="delete btn btn-danger">删除</button>'+
                    '<button class="btn btn-success attend">打卡上班</button><button class="delete btn offwork">打卡下班</button></td>'+
                    '<td class="uploadTime"></td>'+
                    '<td class="distance"></td>'+
                '</tr>';
        console.log($('#courierTable tbody'));
        $('#courierTable tbody').append(trStr);
    }).on('click','#getSessionKey',function(){
    	
         $.ajax({
                    url: '/controller.do?login',
                    data: {
						id: 'getAccess',
						login_name: 'fshdskjf',
						password: '1367jhd'
					},
                    success: function(data){
                        if(data.success){
                           $('#sessionKey').val(data.sessionkey);
                        }else{
                            alert(data.msg);
                        }
                    },
                    error: function(data){
                        layer.msg(data.error);
                    }
                });
    }).on('click','.upload',function(){
        var tr = $(this).parents('tr');//获取该行
        var courier = {
            'mLongitude' : $('#m_lon').val(),//获取商家经度
            'mLatitude' : $('#m_dim').val(),//获取商家纬度
            'userId' : tr.find('.courierID').val(),//获取快递员id
            'uLongitude' : tr.find('.lon').val(),//获取快递员经度
            'uLatitude' : tr.find('.dim').val(),//获取快递员纬度
			'sessionkey': $('#sessionKey').val()
        };
		
        console.log(courier);
        if(courier.mLongitude&&courier.mLatitude){
            if(courier.userId&&courier.mLongitude&&courier.mLatitude){
                console.log('快递员id'+courier.userId+'快递员经度'+courier.uLongitude+'快递员纬度'+courier.uLatitude);
               
                $.ajax({
                    url: '/ci/courierController.do?saveUserLocationIntoRedis',
                    data: courier,
                    success: function(data){
                        if(data.success){
                            tr.find('.uploadTime').html(data.obj.uploadTime);
                            tr.find('.distance').html(data.obj.distance);
							tr.find('.courierName').val(data.obj.userName);
                        }else{
                            alert(data.success);
                        }
                    },
                    error: function(data){
                        layer.msg(data.error);
                    }
                });
            }else{
                alert('请填写完整快递员信息！')
            }
        }else{
            alert('请填写商家的位置！');
        }
		});
	}).on('click','.btn-danger',function(){
        var tr = $(this).parents('tr');//获取该行
        var courier = {
            'userId' : tr.find('.courierID').val(),//获取快递员id
			'sessionkey': $('#sessionKey').val()
        };
        console.log(courier);
            if(courier.userId){
                console.log('快递员id'+courier.userId);
                $.ajax({
                    url: '/ci/courierController.do?cleanUserLocationInRedis',
                    data: courier,
                    success: function(data){
                        if(data.success){
                        	alert("位置清除成功");
                        }else{
                            alert(data.success);
                        }
                    },
                    error: function(data){
                        layer.msg(data.error);
                    }
                });
            }else{
                alert('请填写完整快递员信息！')
            }
}).on('click','.attend',function(){
    var tr = $(this).parents('tr');//获取该行
    var courier = {
    		'userId' : tr.find('.courierID').val(),//获取快递员id
            'longitude' : tr.find('.lon').val(),//获取快递员经度
            'latitude' : tr.find('.dim').val(),//获取快递员纬度
            'type' :'0',
            'address' :'abc',
            'deviceInfo' :'abc',
			'sessionkey': $('#sessionKey').val()
        };
    if(courier.longitude&&courier.longitude){
    console.log(courier);
        if(courier.userId){
            console.log('快递员id'+courier.userId);
            $.ajax({
                url: '/ci/attendanceController.do?saveAttendance',
                data: courier,
                success: function(data){
                    if(data.success){
                    	alert("打卡上班成功");
                    }else{
                        alert(data.msg);
                    }
                },
                error: function(data){
                    layer.msg(data.error);
                }
            });
        }else{
            alert('请填写完整快递员信息！')
        }
    }else{
        	   alert('请填写位置信息！')
        }
    
}).on('click','.offwork',function(){
    var tr = $(this).parents('tr');//获取该行
    var courier = {
            'userId' : tr.find('.courierID').val(),//获取快递员id
            'longitude' : tr.find('.lon').val(),//获取快递员经度
            'latitude' : tr.find('.dim').val(),//获取快递员纬度
            'type' :'1',
            'address' :'abc',
    		'deviceInfo' :'abc',
			'sessionkey': $('#sessionKey').val()
        };
    if(courier.longitude&&courier.longitude){
    console.log(courier);
        if(courier.userId){
            console.log('快递员id'+courier.userId); 
            $.ajax({
                url: '/ci/attendanceController.do?saveAttendance',
                data: courier,
                success: function(data){
                    if(data.success){
                    	alert("打卡下班成功");
                    }else{
                        alert(data.msg);
                    }
                },
                error: function(data){
                    layer.msg(data.error);
                }
            });
        }else{
            alert('请填写完整快递员信息！')
        }
    }else{
        	alert('请填写位置信息！')
        	}
});
    
</script>
</block>
<block name="main_content">
    <h1>快递员推单测试模拟</h1>
    <div class="widget">
        <span>商家位置：</span><span>经度<input id="m_lon" class="form-control" type="number" /></span><span style="margin-left:20px;">纬度<input id="m_dim" class="form-control" type="number" />
				sessionKey:<input id="sessionKey" class="form-control" size="50" />
		</span>
    </div>
    <div id="courierTable" class="row-fluid form-horizontal">
        <div class=" widget">
            <button id="plus" class="btn btn-success">新增快递员位置</button>
			<button id="getSessionKey" class="btn btn-success">获取sessionKey</button>
        </div>
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th><span class="required">*</span>快递员ID</th>
                    <th>快递员名称</th>
                    <th><span class="required">*</span>经度</th>
                    <th><span class="required">*</span>纬度</th>
                    <th>操作</th>
                    <th>上传时间</th>
                    <th>距离</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="number" class="courierID"/></td>
                    <td><input type="text" class="courierName"/></td>
                    <td><input type="number" class="lon"/></td>
                    <td><input type="number" class="dim"/></td>
                    <td><button class="btn btn-success upload">上传</button><button class="delete btn btn-danger">删除</button><button class="btn btn-success attend">打卡上班</button><button class="delete btn offwork">打卡下班</button></td>
                    <td class="uploadTime"></td>
                    <td class="distance"></td>
                </tr>
            </tbody>
        </table>
    </div>
</block>
